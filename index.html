<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ai Là Triệu Phú - Bi kịch Hamlet</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://kit.fontawesome.com/a076d05399.js" crossorigin="anonymous"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
            color: #e2e8f0;
            min-height: 100vh;
        }
        .container-wrapper {
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
        }
        .question-card, .help-section, .quiz-ladder {
            background-color: #1f2937;
            border-radius: 12px;
            box-shadow: 0 10px 15px rgba(0, 0, 0, 0.3);
            border: 1px solid #374151;
        }
        .option-button {
            transition: all 0.2s ease-in-out;
            transform-origin: center;
        }
        .option-button:not(.disabled):hover {
            transform: scale(1.02);
            background-color: #3b82f6;
            box-shadow: 0 4px 6px rgba(59, 130, 246, 0.3);
        }
        .option-correct {
            background-color: #10b981 !important;
        }
        .option-incorrect {
            background-color: #ef4444 !important;
        }
        .option-button.disabled {
            cursor: not-allowed;
            opacity: 0.6;
        }

        /* Styling cho Thanh tiến độ (Quiz Ladder) */
        .ladder-item {
            position: relative;
            padding: 8px 12px;
            margin-bottom: 4px;
            border-radius: 8px;
            font-weight: 600;
            transition: all 0.3s;
            text-shadow: 0 1px 1px rgba(0, 0, 0, 0.4);
        }
        .ladder-item-unlocked {
            background-color: #374151;
            color: #9ca3af;
        }
        .ladder-item-current {
            background-color: #f59e0b; /* Màu cam nổi bật */
            color: #1f2937;
            transform: scale(1.05);
            box-shadow: 0 4px 8px rgba(245, 158, 11, 0.5);
        }
        .ladder-item-milestone {
            background-color: #14b8a6; /* Màu xanh ngọc cho mốc */
            color: #1f2937;
        }

        /* Modal styling */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            backdrop-filter: blur(5px);
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }
        .modal-overlay.open {
            opacity: 1;
            visibility: visible;
        }
        .modal-content {
            background: #1f2937;
            color: #e2e8f0;
            padding: 24px;
            border-radius: 12px;
            width: 90%;
            max-width: 600px;
            box-shadow: 0 15px 30px rgba(0, 0, 0, 0.5);
            transform: scale(0.8);
            transition: transform 0.3s ease;
        }
        .modal-overlay.open .modal-content {
            transform: scale(1);
        }
        .audience-bar {
            height: 20px;
            background-color: #374151;
            margin-bottom: 8px;
            border-radius: 4px;
            overflow: hidden;
            transition: width 0.5s ease;
        }
        .bar-fill {
            height: 100%;
            border-radius: 4px;
        }
        .loading-spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3b82f6;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>

    <div class="container-wrapper">
        <header class="py-4 text-center">
            <h1 class="text-4xl font-extrabold text-yellow-400">AI LÀ TRIỆU PHÚ</h1>
            <h2 class="text-xl text-blue-300 mt-2">Đoạn trích: "Sống hay không sống" (Hamlet)</h2>
        </header>

        <main class="grid grid-cols-1 lg:grid-cols-3 gap-6 mt-6">
            <!-- Cột bên trái: Hỗ trợ và Tiến trình -->
            <div class="lg:col-span-1 space-y-6 order-2 lg:order-1">

                <!-- Quyền Trợ Giúp -->
                <div id="help-section" class="help-section p-4">
                    <h3 class="text-lg font-semibold border-b border-gray-600 pb-2 mb-3 text-yellow-400">Quyền Trợ Giúp</h3>
                    <div class="grid grid-cols-2 gap-3">
                        <button id="help-50-50" class="help-button bg-gray-600 hover:bg-gray-500 text-white font-bold py-2 px-4 rounded-lg transition" onclick="useHelp('50:50')">
                            <i class="fas fa-divide mr-2"></i> 50:50
                        </button>
                        <button id="help-audience" class="help-button bg-gray-600 hover:bg-gray-500 text-white font-bold py-2 px-4 rounded-lg transition" onclick="useHelp('audience')">
                            <i class="fas fa-users mr-2"></i> Khán Giả
                        </button>
                        <button id="help-poll" class="help-button bg-gray-600 hover:bg-gray-500 text-white font-bold py-2 px-4 rounded-lg transition" onclick="useHelp('poll')">
                            <i class="fas fa-chart-bar mr-2"></i> Khảo Sát
                        </button>
                        <button id="help-sage" class="help-button bg-gray-600 hover:bg-gray-500 text-white font-bold py-2 px-4 rounded-lg transition" onclick="useHelp('sage')">
                            <i class="fas fa-brain mr-2"></i> Nhà Thông Thái
                        </button>
                    </div>
                </div>

                <!-- Cây Tiền Thưởng (Quiz Ladder) -->
                <div class="quiz-ladder p-4">
                    <h3 class="text-lg font-semibold border-b border-gray-600 pb-2 mb-3 text-yellow-400">Cây Tiền Thưởng</h3>
                    <div id="ladder" class="space-y-1">
                        <!-- Items sẽ được chèn bởi JavaScript -->
                    </div>
                    <div id="current-winnings" class="mt-4 text-center text-xl font-bold text-teal-400">
                        Tiền Thưởng Hiện Tại: 0 VNĐ
                    </div>
                </div>
            </div>

            <!-- Cột chính: Câu hỏi và Lựa chọn -->
            <div class="lg:col-span-2 space-y-6 order-1 lg:order-2">
                <!-- Câu hỏi -->
                <div id="question-card" class="question-card p-6 min-h-[250px] flex flex-col justify-center">
                    <p id="question-level" class="text-sm font-medium mb-2 text-blue-400"></p>
                    <h2 id="question-text" class="text-2xl font-bold mb-6 text-white"></h2>
                    <div id="options-container" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <!-- Options sẽ được chèn bởi JavaScript -->
                    </div>
                </div>
                <div class="text-center">
                    <button id="stop-button" class="bg-red-600 hover:bg-red-700 text-white font-bold py-3 px-6 rounded-full text-xl transition transform hover:scale-105 shadow-lg" onclick="handleMilestoneDecision(true)" disabled>
                        <i class="fas fa-money-bill-wave mr-2"></i> DỪNG CUỘC CHƠI
                    </button>
                </div>
            </div>
        </main>
    </div>

    <!-- Modal cho Khán Giả, Khảo Sát, Nhà Thông Thái, và Dừng Cuộc Chơi -->
    <div id="quiz-modal" class="modal-overlay" onclick="closeModal()">
        <div class="modal-content" onclick="event.stopPropagation()">
            <h3 id="modal-title" class="text-2xl font-bold mb-4 text-center"></h3>
            <div id="modal-body" class="mb-6 space-y-3">
                <!-- Nội dung Modal sẽ hiển thị ở đây -->
            </div>
            <div class="text-center">
                <button id="modal-close-button" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-6 rounded-lg transition" onclick="closeModal()">
                    Đóng
                </button>
                <button id="modal-continue-button" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-6 rounded-lg ml-3 transition hidden" onclick="handleMilestoneDecision(false)">
                    Tiếp Tục Chơi
                </button>
            </div>
        </div>
    </div>

    <script type="module">
        // Import các hàm cần thiết từ Firebase SDK
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Cấu hình Firebase & Auth
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        // FIX: Đổi tên biến cục bộ để tránh lỗi ReferenceError (TDZ)
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null; 
        const apiKey = ""; // API Key cho Gemini
        const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;

        let db, auth;
        let userId;

        const initFirebase = async () => {
            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                if (initialAuthToken) { // Sử dụng biến đã sửa tên
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }
                userId = auth.currentUser?.uid || crypto.randomUUID();
                console.log("Firebase và Auth đã sẵn sàng. User ID:", userId);
            } catch (error) {
                console.error("Lỗi khởi tạo Firebase/Auth:", error);
            }
        };

        // --- DỮ LIỆU CÂU HỎI VÀ MỐC TIỀN THƯỞNG ---
        const ALL_QUESTIONS = [
            // NB (Nhận biết)
            { q: 1, level: "NB", text: "Đoạn trích \"Sống hay không sống\" (To be or not to be) nằm trong vở kịch nổi tiếng nào của William Shakespeare?", options: ["Macbeth", "Romeo và Juliet", "Othello", "Hamlet"], answer: "Hamlet" },
            { q: 2, level: "NB", text: "Theo văn bản, William Shakespeare được mệnh danh là gì?", options: ["“thiên tài sân khấu” và “người khổng lồ của ngôn ngữ”", "“thiên tài sân khấu” và “biển cả của ngôn ngữ Anh”", "“người tiên phong của chủ nghĩa nhân văn”", "“biển cả của ngôn ngữ Anh” và “người cha của kịch Phục Hưng”"], answer: "“thiên tài sân khấu” và “biển cả của ngôn ngữ Anh”" },
            { q: 3, level: "NB", text: "Trong bối cảnh đoạn trích, hành động của Vua Claudius và Polonius dàn xếp cuộc gặp gỡ giữa Hamlet và Ophelia nhằm mục đích chính là gì?", options: ["An ủi và giúp Hamlet hàn gắn mối quan hệ với người yêu.", "Thử thách lòng trung thành của Ophelia đối với triều đình.", "Gài bẫy và rình rập để theo dõi mọi cử chỉ của Hamlet.", "Tìm kiếm chứng cứ để buộc tội Hamlet về tội phản nghịch."], answer: "Gài bẫy và rình rập để theo dõi mọi cử chỉ của Hamlet." },
            { q: 4, level: "NB", text: "Cốt lõi của câu hỏi \"Sống hay không sống – đó mới là vấn đề\" của Hamlet là gì?", options: ["Lựa chọn giữa việc trả thù và tha thứ cho Claudius.", "Thử thách lòng dũng cảm của bản thân trước cái chết.", "Sự giằng co giữa ý chí sống và nỗi tuyệt vọng.", "Nỗi đau khổ vì tình yêu bị Ophelia khinh rẻ."], answer: "Sự giằng co giữa ý chí sống và nỗi tuyệt vọng." },
            { q: 5, level: "NB", text: "Vở kịch \"Hamlet\" là một trong mấy bi kịch lớn nhất của Shakespeare?", options: ["Hai bi kịch lớn nhất", "Bốn bi kịch lớn nhất", "Sáu bi kịch lớn nhất", "Ba bi kịch lớn nhất"], answer: "Bốn bi kịch lớn nhất" },
            // TH (Thông hiểu)
            { q: 6, level: "TH", text: "Sự giằng xé nội tâm dữ dội của Hamlet trong độc thoại được mô tả là đấu tranh giữa những điều gì?", options: ["Giữa bản năng sợ hãi điều chưa biết và lý trí muốn hành động báo thù.", "Giữa nỗi khổ đau của cuộc sống muốn chấm dứt và nỗi sợ hãi điều vô định sau cái chết.", "Giữa tình yêu bị khinh rẻ và sự căm phẫn đối với tội ác của Claudius.", "Giữa vai trò hoàng tử và mong muốn làm một người bình thường."], answer: "Giữa nỗi khổ đau của cuộc sống muốn chấm dứt và nỗi sợ hãi điều vô định sau cái chết." },
            { q: 7, level: "TH", text: "Lời thoại của Polonius chỉ đạo Ophelia tạo \"vẻ tự nhiên\" bằng cách cầm sách đọc, đồng thời thừa nhận thói quen của triều đình là \"khoác cái vẻ trầm mặc thành kính\" nhằm bộc lộ điều gì về môi trường triều đình?", options: ["Sự kính trọng đối với việc học tập và đọc sách ở triều đình.", "Sự toan tính và giả dối của triều đình, sẵn sàng tạo ra vẻ ngoài 'trầm mặc thành kính' để đánh lừa.", "Sự cô đơn của Ophelia khi phải đối mặt với nỗi đau.", "Sự quan tâm của Polonius đến hình ảnh con gái mình trước mặt Hoàng tử Hamlet."], answer: "Sự toan tính và giả dối của triều đình, sẵn sàng tạo ra vẻ ngoài 'trầm mặc thành kính' để đánh lừa." },
            { q: 8, level: "TH", text: "Lời độc thoại ngắn của Vua Claudius tự so sánh hành động của hắn với sự giả tạo của \"gái hồng lâu\" có ý nghĩa gì?", options: ["Thể hiện nỗi sợ hãi khi bị bại lộ tội ác và sự hối hận vì đã phản bội anh trai.", "Xác nhận Claudius là kẻ tội phạm thực sự, làm tăng thêm tính chính đáng cho sứ mệnh trả thù của Hamlet.", "Cho thấy Claudius nhận ra sự vô vọng trong việc cải tà quy chính.", "Phê phán đạo đức suy đồi của triều đình Đan Mạch."], answer: "Xác nhận Claudius là kẻ tội phạm thực sự, làm tăng thêm tính chính đáng cho sứ mệnh trả thù của Hamlet." },
            { q: 9, level: "TH", text: "Theo văn bản, bi kịch của \"con người trí thức thời Phục Hưng\" (như Hamlet) được thể hiện chủ yếu là gì?", options: ["Bị giằng xé giữa lòng yêu nước và sự thù hận đối với chú ruột.", "Hiểu rõ cái xấu, căm hận tội ác nhưng không đủ sức vượt lên hành động vì suy tư quá mức.", "Không thể phân biệt được giữa đức hạnh và sắc đẹp trong cuộc sống điên loạn.", "Bị tha hóa và phải đối mặt với bi kịch lựa chọn trong một thế giới giả dối."], answer: "Hiểu rõ cái xấu, căm hận tội ác nhưng không đủ sức vượt lên hành động vì suy tư quá mức." },
            { q: 10, level: "TH", text: "Tính nhân văn và ý thức về phẩm giá con người của Hamlet được văn bản nhấn mạnh qua điều gì?", options: ["Sự chần chừ, không hành động ngay lập tức để báo thù.", "Việc căm hận tội ác nhưng không hành động mù quáng, muốn tìm chân lý và quý trọng sự sống.", "Lời độc thoại thể hiện sự giằng co giữa ý chí sống và nỗi tuyệt vọng.", "Việc trả lại những vật chứng tình yêu cho Ophelia."], answer: "Việc căm hận tội ác nhưng không hành động mù quáng, muốn tìm chân lý và quý trọng sự sống." },
            // VDC (Vận dụng cao)
            { q: 11, level: "VDC", text: "Ba khía cạnh \"Dò xét và nghi ngờ,\" \"Gài bẫy và rình rập,\" và \"Tha hóa và bi kịch lương tâm\" có chức năng quan trọng nhất là gì đối với sự xuất hiện của Hamlet sau đó?", options: ["Làm nổi bật sự ngây thơ và trong sáng của Ophelia trong bối cảnh triều đình.", "Giải thích trực tiếp nguyên nhân khiến Hamlet quyết định tự tử.", "Tạo lập xung đột kịch bằng cách đặt Hamlet vào một môi trường thù địch và giả dối tột độ, lý giải cho sự bế tắc của chàng.", "Mở đầu cho kế hoạch trả thù của Hamlet đối với Vua Claudius."], answer: "Tạo lập xung đột kịch bằng cách đặt Hamlet vào một môi trường thù địch và giả dối tột độ, lý giải cho sự bế tắc của chàng." },
            { q: 12, level: "VDC", text: "Lời than thở của Hamlet về \"sự gian dối của sắc đẹp\" và tuyên bố \"vừa yêu Ophelia một lần vừa chưa bao giờ yêu nàng\" phản ánh sâu sắc nhất điều gì về chàng?", options: ["Sự thất vọng vì Ophelia đã không còn yêu chàng như trước.", "Sự bối rối, rối loạn tâm thần không kiểm soát được lời nói.", "Sự hoài nghi cực độ của chàng đối với mối quan hệ giữa nhan sắc và đức hạnh trong một thế giới đã bị tha hóa.", "Lòng căm ghét đối với tất cả phụ nữ, bao gồm cả mẹ và Ophelia."], answer: "Sự hoài nghi cực độ của chàng đối với mối quan hệ giữa nhan sắc và đức hạnh trong một thế giới đã bị tha hóa." },
            { q: 13, level: "VDC", text: "Văn bản phân tích sự 'trì hoãn bi kịch' (tragic delay) của Hamlet chủ yếu là do yếu tố nào chi phối?", options: ["Sự bế tắc và bất lực do thiếu cơ hội hành động thích hợp.", "Xung đột giữa việc bị giam cầm trong chính tâm trí mình (suy tư quá mức) và yêu cầu hành động của thực tại.", "Thiếu vắng sự hỗ trợ và hợp tác từ những người bạn như Rosencrantz và Guildenstern.", "Sợ hãi đối mặt với Vua Claudius vì quyền lực và sự nguy hiểm của hắn."], answer: "Xung đột giữa việc bị giam cầm trong chính tâm trí mình (suy tư quá mức) và yêu cầu hành động của thực tại." },
            { q: 14, level: "VDC", text: "Theo văn bản, hiện tượng tâm lý xã hội hiện đại nào được coi là \"bản sao hiện đại của trì hoãn bi kịch\" (tragic delay) của Hamlet?", options: ["Khủng hoảng nghề nghiệp do thiếu đam mê.", "Sự gia tăng các vấn đề tinh thần như trầm cảm và lo âu.", "Xung đột đạo đức giữa làm điều đúng và giữ vị thế trong công việc.", "\"Nghẽn vì phân tích\" (Paralysis by analysis) – hiện tượng suy nghĩ quá nhiều, hành động quá ít do thông tin quá tải."], answer: "\"Nghẽn vì phân tích\" (Paralysis by analysis) – hiện tượng suy nghĩ quá nhiều, hành động quá ít do thông tin quá tải." },
            { q: 15, level: "VDC", text: "Mâu thuẫn nào sau đây được văn bản xác định là cốt lõi của 'bi kịch triết lý' trong lời độc thoại của Hamlet?", options: ["Mâu thuẫn giữa hành động báo thù theo luật danh dự và tuân thủ luật pháp.", "Khủng hoảng về giá trị, ý nghĩa, và lẽ sống của kiếp người.", "Xung đột giữa bổn phận cá nhân và hệ quả xã hội của hành động.", "Sự giằng xé giữa bản năng và lý trí."], answer: "Khủng hoảng về giá trị, ý nghĩa, và lẽ sống của kiếp người." },
        ];

        // Mốc tiền thưởng và mức an toàn (Milestones)
        const WINNINGS_LADDER = [
            { q: 15, amount: "150.000.000 VNĐ", milestone: true },
            { q: 14, amount: "85.000.000 VNĐ", milestone: false },
            { q: 13, amount: "60.000.000 VNĐ", milestone: false },
            { q: 12, amount: "40.000.000 VNĐ", milestone: false },
            { q: 11, amount: "25.000.000 VNĐ", milestone: false },
            { q: 10, amount: "15.000.000 VNĐ", milestone: true }, // Mốc an toàn
            { q: 9, amount: "10.000.000 VNĐ", milestone: false },
            { q: 8, amount: "6.000.000 VNĐ", milestone: false },
            { q: 7, amount: "4.000.000 VNĐ", milestone: false },
            { q: 6, amount: "2.000.000 VNĐ", milestone: false },
            { q: 5, amount: "1.000.000 VNĐ", milestone: true }, // Mốc an toàn
            { q: 4, amount: "500.000 VNĐ", milestone: false },
            { q: 3, amount: "300.000 VNĐ", milestone: false },
            { q: 2, amount: "200.000 VNĐ", milestone: false },
            { q: 1, amount: "100.000 VNĐ", milestone: false },
        ].reverse(); // Đảo ngược để dễ truy cập theo index

        // --- TRẠNG THÁI GAME ---
        let gameState = {
            currentQuestionIndex: 0,
            shuffledQuestions: [],
            isAnswerLocked: false,
            usedHelps: { "50:50": false, "audience": false, "poll": false, "sage": false },
            disabledOptions: [],
            isGameOver: false,
            safeWinnings: "0 VNĐ",
        };

        // --- HÀM TIỆN ÍCH ---

        // Hàm xáo trộn mảng (Fisher-Yates)
        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }

        // Tạo ra danh sách câu hỏi đã xáo trộn theo từng cấp độ
        function setupShuffledQuestions() {
            const nb = ALL_QUESTIONS.filter(q => q.level === 'NB');
            const th = ALL_QUESTIONS.filter(q => q.level === 'TH');
            const vdc = ALL_QUESTIONS.filter(q => q.level === 'VDC');

            const shuffledNb = shuffleArray(nb);
            const shuffledTh = shuffleArray(th);
            const shuffledVdc = shuffleArray(vdc);

            gameState.shuffledQuestions = [...shuffledNb, ...shuffledTh, ...shuffledVdc];
        }

        // Cập nhật Cây Tiền Thưởng và Mốc An toàn
        function updateLadder() {
            const ladderElement = document.getElementById('ladder');
            ladderElement.innerHTML = '';

            let currentWinnings = "0 VNĐ";

            WINNINGS_LADDER.forEach((item, index) => {
                const isMilestone = item.milestone;
                const isCurrent = index === gameState.currentQuestionIndex;
                const isUnlocked = index < gameState.currentQuestionIndex;

                let className = 'ladder-item-unlocked';
                if (isCurrent) {
                    className = 'ladder-item-current';
                    currentWinnings = item.amount;
                } else if (isMilestone) {
                    className = 'ladder-item-milestone';
                }

                if (isUnlocked && isMilestone) {
                    gameState.safeWinnings = item.amount;
                }

                ladderElement.innerHTML += `
                    <div class="ladder-item ${className} flex justify-between">
                        <span>Câu ${item.q}</span>
                        <span>${item.amount}</span>
                    </div>
                `;
            });
            document.getElementById('current-winnings').textContent = `Tiền Thưởng Hiện Tại: ${currentWinnings}`;
        }

        // Cập nhật trạng thái nút DỪNG
        function updateStopButton() {
            const stopButton = document.getElementById('stop-button');
            if (gameState.currentQuestionIndex >= 5 && !gameState.isGameOver) {
                stopButton.disabled = false;
                stopButton.textContent = `DỪNG CUỘC CHƠI (Bảo toàn ${gameState.safeWinnings})`;
            } else {
                stopButton.disabled = true;
                stopButton.textContent = `DỪNG CUỘC CHƠI`;
            }
        }

        // Cập nhật trạng thái nút Trợ Giúp
        function updateHelpButtons() {
            for (const help in gameState.usedHelps) {
                const button = document.getElementById(`help-${help.replace(':', '-')}`);
                if (gameState.usedHelps[help]) {
                    button.disabled = true;
                    button.classList.remove('hover:bg-gray-500');
                    button.classList.add('opacity-50', 'cursor-not-allowed');
                } else {
                    button.disabled = false;
                    button.classList.add('hover:bg-gray-500');
                    button.classList.remove('opacity-50', 'cursor-not-allowed');
                }
            }
        }

        // Hiển thị câu hỏi hiện tại
        function displayQuestion() {
            if (gameState.currentQuestionIndex >= gameState.shuffledQuestions.length) {
                return endGame(true);
            }

            const currentQ = gameState.shuffledQuestions[gameState.currentQuestionIndex];
            document.getElementById('question-level').textContent = `Câu hỏi số ${currentQ.q} - Cấp độ: ${currentQ.level}`;
            document.getElementById('question-text').textContent = currentQ.text;
            document.getElementById('options-container').innerHTML = '';

            const optionLabels = ["A", "B", "C", "D"];
            const shuffledOptions = shuffleArray([...currentQ.options]);

            currentQ.shuffledOptions = shuffledOptions; // Lưu lại thứ tự xáo trộn

            shuffledOptions.forEach((optionText, index) => {
                const label = optionLabels[index];
                const isDisabled = gameState.disabledOptions.includes(label);
                const buttonClass = isDisabled ? 'disabled opacity-50' : 'hover:bg-blue-600';

                document.getElementById('options-container').innerHTML += `
                    <button id="option-${label}" data-label="${label}"
                        class="option-button bg-gray-700 ${buttonClass} text-left text-lg font-medium p-3 rounded-lg flex items-center shadow-md disabled:cursor-not-allowed"
                        ${isDisabled || gameState.isAnswerLocked ? 'disabled' : ''}
                        onclick="checkAnswer('${label}')">
                        <span class="font-bold text-yellow-300 mr-3">${label}:</span>
                        <span class="flex-1">${optionText}</span>
                    </button>
                `;
            });
            gameState.isAnswerLocked = false;
            updateLadder();
            updateStopButton();
        }

        // --- LOGIC TRÒ CHƠI ---

        window.checkAnswer = function(selectedLabel) {
            if (gameState.isAnswerLocked || gameState.isGameOver) return;
            gameState.isAnswerLocked = true;

            const currentQ = gameState.shuffledQuestions[gameState.currentQuestionIndex];
            const selectedText = currentQ.shuffledOptions[["A", "B", "C", "D"].indexOf(selectedLabel)];
            const isCorrect = selectedText === currentQ.answer;

            const optionButton = document.getElementById(`option-${selectedLabel}`);
            const correctLabel = ["A", "B", "C", "D"][currentQ.shuffledOptions.indexOf(currentQ.answer)];
            const correctButton = document.getElementById(`option-${correctLabel}`);

            // Tô màu đáp án người chơi chọn
            optionButton.classList.remove('bg-gray-700');
            optionButton.classList.add(isCorrect ? 'bg-yellow-500' : 'bg-red-600', 'transform', 'scale-105');

            setTimeout(() => {
                if (isCorrect) {
                    // Tô màu đáp án đúng và chuyển câu
                    correctButton.classList.remove('bg-yellow-500');
                    correctButton.classList.add('option-correct');
                    setTimeout(() => {
                        gameState.currentQuestionIndex++;
                        gameState.disabledOptions = [];
                        if (gameState.currentQuestionIndex === 5 || gameState.currentQuestionIndex === 10 || gameState.currentQuestionIndex === 15) {
                            handleMilestone();
                        } else {
                            displayQuestion();
                        }
                    }, 1500);
                } else {
                    // Trả lời sai
                    correctButton.classList.remove('bg-gray-700');
                    correctButton.classList.add('option-correct');
                    setTimeout(() => {
                        endGame(false);
                    }, 2000);
                }
            }, 1000);
        }

        function handleMilestone() {
            if (gameState.currentQuestionIndex === 15) {
                endGame(true);
                return;
            }

            const currentAmount = WINNINGS_LADDER[gameState.currentQuestionIndex - 1].amount;
            const modal = document.getElementById('quiz-modal');
            document.getElementById('modal-title').textContent = "MC: Quyết định quan trọng!";
            document.getElementById('modal-body').innerHTML = `
                <p class="text-xl text-center font-semibold">Bạn đã vượt qua mốc quan trọng Câu ${gameState.currentQuestionIndex}!</p>
                <p class="text-lg text-center">Bạn có muốn **DỪNG CUỘC CHƠI** để ra về an toàn với số tiền **${currentAmount}** không?</p>
                <div class="flex justify-center space-x-4 mt-4">
                    <button class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-6 rounded-lg transition" onclick="handleMilestoneDecision(true)">
                        <i class="fas fa-hand-paper mr-2"></i> Có, Dừng Lại!
                    </button>
                    <button class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-6 rounded-lg transition" onclick="handleMilestoneDecision(false)">
                        <i class="fas fa-play-circle mr-2"></i> Không, Chơi Tiếp!
                    </button>
                </div>
            `;
            document.getElementById('modal-close-button').classList.add('hidden');
            modal.classList.add('open');
        }

        window.handleMilestoneDecision = function(isStop) {
            closeModal();
            if (isStop) {
                endGame(true, true); // Dừng chủ động
            } else {
                displayQuestion(); // Chơi tiếp
            }
        }

        function endGame(isWinner, isStop = false) {
            gameState.isGameOver = true;
            let finalWinnings = isWinner ? WINNINGS_LADDER[WINNINGS_LADDER.length - 1].amount : gameState.safeWinnings;
            let message = "";
            let title = "";

            if (isWinner) {
                title = "CHÚC MỪNG! BẠN LÀ TRIỆU PHÚ!";
                message = `Bạn đã trả lời đúng tất cả 15 câu hỏi và giành được giải thưởng cao nhất: **${finalWinnings}**!`;
                finalWinnings = WINNINGS_LADDER[WINNINGS_LADDER.length - 1].amount;
            } else if (isStop) {
                title = "DỪNG CUỘC CHƠI AN TOÀN";
                finalWinnings = WINNINGS_LADDER[gameState.currentQuestionIndex - 1].amount;
                message = `Bạn đã quyết định dừng cuộc chơi. Tiền thưởng bạn mang về là: **${finalWinnings}**!`;
            } else {
                title = "RẤT TIẾC, TRẢ LỜI SAI!";
                message = `Bạn đã trả lời sai! Tiền thưởng an toàn bạn ra về là: **${gameState.safeWinnings}**.`;
            }

            const modal = document.getElementById('quiz-modal');
            document.getElementById('modal-title').textContent = title;
            document.getElementById('modal-body').innerHTML = `
                <p class="text-xl text-center font-semibold">${message}</p>
            `;
            document.getElementById('modal-close-button').textContent = "Chơi Lại";
            document.getElementById('modal-close-button').onclick = resetGame;
            document.getElementById('modal-close-button').classList.remove('hidden');
            document.getElementById('modal-continue-button').classList.add('hidden');
            modal.classList.add('open');
            document.getElementById('stop-button').disabled = true;
        }

        window.resetGame = function() {
            gameState = {
                currentQuestionIndex: 0,
                shuffledQuestions: [],
                isAnswerLocked: false,
                usedHelps: { "50:50": false, "audience": false, "poll": false, "sage": false },
                disabledOptions: [],
                isGameOver: false,
                safeWinnings: "0 VNĐ",
            };
            setupShuffledQuestions();
            updateHelpButtons();
            closeModal();
            displayQuestion();
        }

        // --- LOGIC TRỢ GIÚP ---

        window.useHelp = async function(helpType) {
            if (gameState.isGameOver || gameState.usedHelps[helpType]) return;

            gameState.usedHelps[helpType] = true;
            updateHelpButtons();
            const currentQ = gameState.shuffledQuestions[gameState.currentQuestionIndex];
            const correctOption = currentQ.answer;

            const modal = document.getElementById('quiz-modal');
            const modalBody = document.getElementById('modal-body');
            document.getElementById('modal-close-button').classList.remove('hidden');

            switch (helpType) {
                case '50:50':
                    document.getElementById('modal-title').textContent = "Trợ Giúp 50:50";
                    modalBody.innerHTML = `<p class="text-center">Hệ thống đang loại bỏ 2 phương án sai...</p>`;
                    modal.classList.add('open');
                    setTimeout(() => {
                        apply5050(currentQ, correctOption);
                        modalBody.innerHTML = `<p class="text-center text-xl font-bold text-yellow-400">Đã loại bỏ 2 phương án sai. Hãy tiếp tục chọn!</p>`;
                    }, 1500);
                    break;

                case 'audience':
                    document.getElementById('modal-title').textContent = "Hỏi Ý Kiến Khán Giả";
                    modalBody.innerHTML = `<p class="text-center flex justify-center items-center"><div class="loading-spinner mr-3"></div>Khán giả đang tranh luận...</p>`;
                    modal.classList.add('open');
                    await askAudience(currentQ, correctOption, modalBody);
                    break;

                case 'poll':
                    document.getElementById('modal-title').textContent = "Khảo Sát Trường Quay";
                    modalBody.innerHTML = `<p class="text-center flex justify-center items-center"><div class="loading-spinner mr-3"></div>Đang thu thập kết quả khảo sát...</p>`;
                    modal.classList.add('open');
                    setTimeout(() => {
                        displayPollResults(currentQ, correctOption, modalBody);
                    }, 2000);
                    break;

                case 'sage':
                    document.getElementById('modal-title').textContent = "Liên Hệ Nhà Thông Thái";
                    modalBody.innerHTML = `<p class="text-center flex justify-center items-center"><div class="loading-spinner mr-3"></div>Đang kết nối với Nhà Thông Thái...</p><p class="text-center text-sm text-gray-400">Bạn có 30 giây để nghe tư vấn từ AI.</p>`;
                    modal.classList.add('open');
                    await contactSage(currentQ, modalBody);
                    break;
            }
        }

        function apply5050(currentQ, correctOption) {
            const allOptions = ["A", "B", "C", "D"];
            const correctLabel = allOptions[currentQ.shuffledOptions.indexOf(correctOption)];
            const wrongOptions = allOptions.filter(label => label !== correctLabel);

            // Xáo trộn các câu sai và loại bỏ 2 câu đầu tiên
            shuffleArray(wrongOptions);
            const optionsToDisable = [wrongOptions[0], wrongOptions[1]];

            gameState.disabledOptions = optionsToDisable;
            displayQuestion();
        }

        function displayPollResults(currentQ, correctOption, modalBody) {
            const allOptions = ["A", "B", "C", "D"];
            const correctLabel = allOptions[currentQ.shuffledOptions.indexOf(correctOption)];
            const results = {};
            let total = 100;

            // Đảm bảo câu đúng có xu hướng % cao hơn (ví dụ 45-70%)
            let correctPercentage = Math.floor(Math.random() * (70 - 45 + 1)) + 45;
            results[correctLabel] = correctPercentage;
            total -= correctPercentage;

            // Phân bổ ngẫu nhiên phần còn lại cho 3 câu sai
            const wrongLabels = allOptions.filter(label => label !== correctLabel);
            let remainingWrong = total;

            for (let i = 0; i < wrongLabels.length; i++) {
                if (i === wrongLabels.length - 1) {
                    results[wrongLabels[i]] = remainingWrong;
                } else {
                    // Phân bổ ngẫu nhiên, giới hạn để không vượt quá phần còn lại
                    let maxSlice = Math.min(remainingWrong - (wrongLabels.length - 1 - i), Math.floor(remainingWrong / 2) + 10);
                    let percentage = Math.floor(Math.random() * maxSlice) + 1;
                    results[wrongLabels[i]] = percentage;
                    remainingWrong -= percentage;
                }
            }

            // Đảm bảo tổng là 100% (do làm tròn có thể bị sai)
            const currentTotal = Object.values(results).reduce((a, b) => a + b, 0);
            if (currentTotal !== 100) {
                results[correctLabel] += (100 - currentTotal);
            }

            // Xây dựng giao diện kết quả
            let pollHtml = '<p class="text-center text-xl font-bold mb-4 text-teal-400">Kết quả Khảo Sát Trường Quay:</p>';
            allOptions.forEach(label => {
                const percentage = results[label];
                pollHtml += `
                    <div class="mb-2">
                        <div class="flex justify-between font-medium text-white">
                            <span>${label} (${currentQ.shuffledOptions[allOptions.indexOf(label)]}):</span>
                            <span>${percentage}%</span>
                        </div>
                        <div class="audience-bar">
                            <div class="bar-fill" style="width: ${percentage}%; background-color: ${label === correctLabel ? '#10b981' : '#f59e0b'};"></div>
                        </div>
                    </div>
                `;
            });
            modalBody.innerHTML = pollHtml;
        }

        async function askAudience(currentQ, correctOption, modalBody) {
            const allOptions = ["A", "B", "C", "D"];
            const correctLabel = allOptions[currentQ.shuffledOptions.indexOf(correctOption)];
            let chatHtml = '<p class="text-center text-xl font-bold mb-4 text-teal-400">Khán Giả Tranh Luận:</p>';
            const debaters = ["Khán Giả 1 (GV Lịch Sử)", "Khán Giả 2 (Sinh Viên Văn)", "Khán Giả 3 (Kỹ Sư)", "Khán Giả 4 (Nội Trợ)", "Khán Giả 5 (Học Sinh PTTH)"];

            // Logic random chọn (bias nhẹ về câu đúng)
            const opinions = {};
            allOptions.forEach(label => opinions[label] = 0);

            for (let i = 0; i < 5; i++) {
                let choice;
                if (Math.random() < 0.6) { // 60% chọn câu đúng
                    choice = correctLabel;
                } else {
                    // 40% chọn ngẫu nhiên trong các câu còn lại
                    const available = allOptions.filter(label => !gameState.disabledOptions.includes(label));
                    choice = available[Math.floor(Math.random() * available.length)];
                }

                opinions[choice]++;

                let icon = '<i class="fas fa-comment-dots mr-2 text-blue-400"></i>';
                let rationale;

                // Tự động tạo lý lẽ ngẫu nhiên (chỉ mang tính chất mô phỏng tranh luận)
                if (choice === correctLabel) {
                    rationale = "Tôi nhớ rõ chi tiết này trong tài liệu. Đáp án này rất chắc chắn vì nó trực tiếp được nhắc đến.";
                } else {
                    rationale = "Tôi nghi ngờ về phương án này. Tôi thấy phương án khác có vẻ hợp lý hơn vì...";
                    const wrongOption = allOptions.filter(l => l !== correctLabel)[Math.floor(Math.random() * 3)];
                    rationale = `Tôi lại thấy phương án **${wrongOption}** có lý. Nhưng tôi chọn **${choice}**.`;
                }

                chatHtml += `
                    <div class="p-3 bg-gray-600 rounded-lg shadow-inner">
                        <p class="font-semibold text-yellow-300">${debaters[i]}:</p>
                        <p class="text-white">${icon} Tôi chọn **${choice}**. ${rationale}</p>
                    </div>
                `;
            }

            chatHtml += `<p class="text-lg font-bold text-center mt-4 text-red-300">Kết quả tổng hợp (Mô phỏng): ${Object.entries(opinions).map(([key, value]) => `${key}: ${value}`).join(' | ')}</p>`;
            modalBody.innerHTML = chatHtml;
        }

        async function contactSage(currentQ, modalBody) {
            const sageNames = ["Grok", "Gemini", "Perplexity", "ChatGPT", "Deepseek"];
            const selectedSage = sageNames[Math.floor(Math.random() * sageNames.length)];
            const allOptions = ["A", "B", "C", "D"];
            const currentOptions = currentQ.shuffledOptions.map((text, i) => `${allOptions[i]}. ${text}`).join('\n');
            const questionPrompt = `Câu hỏi: ${currentQ.text}\nCác lựa chọn:\n${currentOptions}\n\nHãy phân tích câu hỏi này (dựa trên các tác phẩm của Shakespeare hoặc văn bản phân tích Hamlet) và đưa ra lời khuyên tốt nhất cho người chơi. Hãy chọn một đáp án (A, B, C hoặc D) và giải thích ngắn gọn lý do. Chỉ trả lời bằng tiếng Việt.`;

            document.getElementById('modal-title').textContent = `Nhà Thông Thái: ${selectedSage}`;
            let timer = 30;
            let timerInterval;

            const updateTimerDisplay = () => {
                document.getElementById('sage-timer').textContent = `Thời gian còn lại: ${timer} giây`;
                if (timer <= 0) {
                    clearInterval(timerInterval);
                    document.getElementById('sage-timer').textContent = "HẾT GIỜ!";
                    document.getElementById('modal-close-button').disabled = false;
                }
            };

            modalBody.innerHTML = `
                <div class="text-center mb-3">
                    <p id="sage-timer" class="text-xl font-bold text-red-500">Thời gian còn lại: 30 giây</p>
                </div>
                <div id="sage-response-area" class="p-4 bg-gray-700 rounded-lg shadow-inner min-h-[150px]">
                    <p class="text-lg text-yellow-400 font-semibold">Nhà Thông Thái đang phân tích...</p>
                    <div class="flex justify-center mt-4"><div class="loading-spinner"></div></div>
                </div>
            `;
            document.getElementById('modal-close-button').disabled = true; // Disable until time runs out or response is back

            timerInterval = setInterval(() => {
                timer--;
                updateTimerDisplay();
            }, 1000);

            try {
                const response = await fetchGemini(questionPrompt);
                clearInterval(timerInterval); // Dừng đồng hồ ngay khi có phản hồi

                const sageResponseArea = document.getElementById('sage-response-area');
                if (response.text) {
                    sageResponseArea.innerHTML = `<p class="text-lg text-yellow-400 font-semibold">${selectedSage} trả lời:</p><p class="mt-2 text-white whitespace-pre-wrap">${response.text}</p>`;
                } else {
                    sageResponseArea.innerHTML = `<p class="text-lg text-red-400">Nhà Thông Thái bận. Hãy tự đưa ra lựa chọn!</p>`;
                }

                // Đảm bảo nút đóng được kích hoạt lại
                document.getElementById('modal-close-button').disabled = false;
                document.getElementById('sage-timer').textContent = `Đã nhận câu trả lời.`;

            } catch (error) {
                console.error("Lỗi gọi Gemini:", error);
                clearInterval(timerInterval);
                document.getElementById('sage-response-area').innerHTML = `<p class="text-lg text-red-400">Lỗi kết nối AI. Hãy tự đưa ra lựa chọn!</p>`;
                document.getElementById('modal-close-button').disabled = false;
                document.getElementById('sage-timer').textContent = `Lỗi kết nối.`;
            }
        }

        // Hàm gọi API Gemini với exponential backoff
        async function fetchGemini(userQuery, retries = 3) {
            const systemPrompt = "Bạn là một Nhà Thông Thái chuyên về Văn học, đặc biệt là các tác phẩm Bi kịch của William Shakespeare. Hãy tư vấn cho người chơi Ai Là Triệu Phú câu trả lời tốt nhất cho câu hỏi học thuật dựa trên nội dung phân tích đoạn trích 'Sống hay không sống' (Hamlet).";
            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                systemInstruction: { parts: [{ text: systemPrompt }] },
            };

            for (let i = 0; i < retries; i++) {
                try {
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) {
                        if (response.status === 429 && i < retries - 1) {
                            await new Promise(resolve => setTimeout(resolve, Math.pow(2, i) * 1000));
                            continue;
                        }
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }

                    const result = await response.json();
                    const candidate = result.candidates?.[0];

                    if (candidate && candidate.content?.parts?.[0]?.text) {
                        return { text: candidate.content.parts[0].text, sources: [] };
                    }
                    throw new Error("Không tìm thấy nội dung phản hồi hợp lệ từ AI.");

                } catch (error) {
                    if (i === retries - 1) {
                        throw error;
                    }
                    await new Promise(resolve => setTimeout(resolve, Math.pow(2, i) * 1000));
                }
            }
        }


        window.closeModal = function() {
            const modal = document.getElementById('quiz-modal');
            modal.classList.remove('open');
            document.getElementById('modal-close-button').onclick = closeModal; // Reset handler
            document.getElementById('modal-close-button').textContent = "Đóng";
        }

        // --- KHỞI TẠO GAME ---

        window.onload = async function() {
            await initFirebase();
            resetGame();
        }
    </script>
</body>
</html>
